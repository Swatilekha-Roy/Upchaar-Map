<!DOCTYPE html>
<html>
  <head>
    <title>Upchaar</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
    <link
      rel="stylesheet"
      href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css"
      type="text/css"
    />
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>

    <!-- Favicon -->
    <link rel="shortcut icon" href="favicon.png" type="image/png" />

    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
      }

      /* Maps */
      #myMap {
        width: 95vw;
        height: 90vh;
        margin-left: 2%;
        margin-top: 5%;
      }
    </style>
  </head>
  <body>
    <!-- Map rendering Div -->
    <div>
      <button onclick="requestGeo()">Load Map</button>
    </div>
    <div id="myMap"></div>

    <!-- Add a reference to the Azure Maps Services Module JavaScript file. -->
    <script src="https://atlas.microsoft.com/sdk/javascript/service/2/atlas-service.min.js"></script>

    <!-- Weglot CDN -->
    <script
      type="text/javascript"
      src="https://cdn.weglot.com/weglot.min.js"
    ></script>

    <script>
      // Primary Key: yciCUjFWK18tlaMkDA_m3Scb0YlOE42E-SOfRhHoBI0
      // Find present device location
      var lat, lon;

      function requestGeo() {
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(geoSuccess, geoFailure);
        } else {
          console.log("No support");
        }
      }

      function geoSuccess(pos) {
        var crd = pos.coords;
        lat = crd.latitude;
        lon = crd.longitude;
        console.log(lat + " " + lon);
        GetMap(lat, lon);
      }

      function geoFailure(error) {
        console.log(error);
      }

      function GetMap(latitude, longitude) {
        //Add Map Control JavaScript code here.
        //Instantiate a map object
        var map = new atlas.Map("myMap", {
          //Add your Azure Maps subscription key to the map SDK. Get an Azure Maps key at https://azure.com/maps
          authOptions: {
            authType: "subscriptionKey",
            subscriptionKey: "yciCUjFWK18tlaMkDA_m3Scb0YlOE42E-SOfRhHoBI0",
          },
        });

        //Wait until the map resources are ready.
        map.events.add("ready", function () {
          //Create a data source and add it to the map.
          datasource = new atlas.source.DataSource();
          map.sources.add(datasource);

          //Add a layer for rendering point data.
          var resultLayer = new atlas.layer.SymbolLayer(datasource, null, {
            iconOptions: {
              image: "pin-round-darkblue",
              anchor: "center",
              allowOverlap: true,
            },
            textOptions: {
              anchor: "top",
            },
          });

          map.layers.add(resultLayer);

          // Use SubscriptionKeyCredential with a subscription key
          var subscriptionKeyCredential =
            new atlas.service.SubscriptionKeyCredential(
              atlas.getSubscriptionKey()
            );

          // Use subscriptionKeyCredential to create a pipeline
          var pipeline = atlas.service.MapsURL.newPipeline(
            subscriptionKeyCredential
          );

          // Construct the SearchURL object
          var searchURL = new atlas.service.SearchURL(pipeline);

          var query = "pharmacy";
          var radius = 9000;
          var lat = latitude;
          var lon = longitude;

          console.log(lat + " " + lon);

          searchURL
            .searchPOI(atlas.service.Aborter.timeout(10000), query, {
              limit: 10,
              lat: lat,
              lon: lon,
              radius: radius,
            })
            .then((results) => {
              // Extract GeoJSON feature collection from the response and add it to the datasource
              var data = results.geojson.getFeatures();
              datasource.add(data);

              // set camera to bounds to show the results
              map.setCamera({
                bounds: data.bbox,
                zoom: 10,
              });
            });
        });
      }

      // Weglot Initialization
      Weglot.initialize({
        api_key: "wg_3bf492e17fb6981ae902dc3248984ab22",
      });
    </script>
  </body>
</html>
